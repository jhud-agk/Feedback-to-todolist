<!--  -->

<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">
  <link rel="" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./styles.css">
  <!-- <script src="https://kit.fontawesome.com/0d24a6d486.js" crossorigin="anonymous"></script> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- <i class="fa-solid fa-circle-check"></i> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
</head>

<style>
  * {
    padding: 0;
    margin: 0;
    font-size: 12px;
  }

  body {
    font-family: 'inter';
  }

  .page,
  .comment_nav_hide,
  .tags {
    display: none;
  }

  .active,
  .comment_nav,
  .tag_active {
    display: block;
  }

  .all_btn {
    outline: none;
    border: none;
    padding: 10px 20px;
    background-color: transparent;
  }

  .btn_solid {
    background-color: #0A99FE;
    color: white;
  }

  .btn_stroke {
    color: #0A99FE;
    border: #0A99FE solid 1px;
    background-color: transparent;
  }

  .first_page {
    padding: 25px;
    border-top: 1px solid #EBEBF2;
    margin-top: 50px;
  }

  .nav {
    display: flex;
    border-bottom: 1px solid #EBEBF2;
  }

  .active_nav,
  .active_navc {
    border-bottom: 1px solid #1E1E1E;
    color: #1E1E1E !important;
  }

  .header_list,
  .header_listc {
    cursor: pointer;
  }

  .nav div {
    color: #BEBEBE;
    padding: 12px 0px 12px 17px;
  }

  .search_con {
    padding: 15px;
    background-color: #FAFAFA;
    border-bottom: 1px solid #EBEBF2;
  }

  .search {
    display: flex;
    align-items: center;
    border: #EBEBF2 solid 1px;
    padding: 2px;
  }

  .input {
    outline: none;
    padding: 10px;
    border: none;
    width: 100%;
  }

  .input::placeholder {
    color: #BEBEBE;
  }

  .footer {
    display: flex;
    gap: 10px;
    justify-content: end;
    padding: 15px;
    border-top: 1px solid #EBEBF2;
    position: fixed;
    bottom: 0px;
    width: 93%;
    background-color: white;
  }

  .bottom {
    border-bottom: 1px solid #EBEBF2;
  }

  .comment_info {
    position: absolute;
    width: 100%;
    height: 100vh;
    background: white;
    height: 100%;
    transition: all 0.6s;
    top: 700px;
  }

  .comment_info_show {
    top: 40px !important;
  }

  .todo_list {
    border: 1px solid #EBEBF2;
    border-radius: 5px;
  }
</style>


<body style="overflow: hidden;">

  <!-- Page 1 -->
  <div id="page1" class="first_page page ">
    <h3 style="font-weight: 600; margin-top: 40px;">Import Figma Comments</h3>
    <p style="margin-top: 10px; color: #7F7979;">Connecting your Figma will allow you easily filter/ Search all your
      Figma comments and
      more. you can add custom
      statuses, to-do-list, due dates and much more, you will only need to do this once per Figma file.</p>

    <button onclick="showNextPage('page2')" class="all_btn btn_solid" style="margin-top: 30px;">Connect This Figma
      File</button>
  </div>


  <!-- page 2  -->
  <div style="height: 100%; overflow-x: scroll;" id="page2" class="page active">
    <div class="nav">
      <div onclick="changePage2Nav(0), commentOverlay(false)" class="header_list active_nav">Figma Comments</div>
      <div onclick="changePage2Nav(1)" class="header_list">Ongoing Tasks</div>
      <div onclick="changePage2Nav(2), commentOverlay(false)" class="header_list">My To-do List</div>
    </div>

    <div class="search_con">
      <div class="search">
        <i style="font-size: 20px; color: #BEBEBE; padding-left: 15px;" class="fa-solid fa-magnifying-glass"></i>
        <input class="input" type="text" placeholder="Search a comment or keyword ...">
        <img src="/assets/search.svg" alt="">
      </div>
    </div>

    <!-- for all comments -->
    <section id="all_comments" class="tags tag_active">
      <section id="page2_sub1" class="page2_sub bottom"
        style="display: flex; align-items: center; justify-content: space-between; padding: 15px;">
        <div class="" style="display: flex; align-items: center; font-weight: 500; gap: 8px;">
          <i class="fa-brands fa-figma"></i>
          <p id="page2_tt">Backlog (0)</p>
        </div>
        <div>
          <input onchange="check_comments()" id="check1" type="checkbox">
        </div>
      </section>

      <section id="page2_sub2" style="margin-bottom: 80px;" class="page2_sub">
        <div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">Loading comments...</p>
        </div>
      </section>
    </section>

    <!-- for ongoing  -->
    <section id="all_ongoing" class="tags">
      <section id="page2_sub1" class="page2_sub bottom"
        style="display: flex; align-items: center; justify-content: space-between; padding: 15px;">
        <div class="" style="display: flex; align-items: center; font-weight: 500; gap: 8px;">
          <i class="fa-brands fa-figma"></i>
          <p id="page2_ttt">Ongoing Tasks (0)</p>
        </div>
        <div>
          <input onchange="check_ongoing()" id="check11" type="checkbox">
        </div>
      </section>

      <section id="page2_sub3" style="margin-bottom: 80px;" class="page2_sub">
        <div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">Loading tasks...</p>
        </div>
        <!-- <div style="display: flex; justify-content: space-between; padding: 15px;" class="bottom">
          <div onclick="showNextPage('page3'), changePage2Nav(3)" style="cursor: pointer; display: flex; gap: 10px;">
            <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
              <img style="height: 28px; width: 28px;  border-radius: 100%;"
                src="https://s3-alpha.figma.com/static/user_p_v2.png" alt="">
            </div>
            <div>
              <h3 style="font-weight: 500;">For hero section interaction and text scroll see ...</h3>
              <p style="margin:8px 0px; color: #7F7979;">Landing page</p>
              <p style="color: #7F7979;">Last comment: 2 mins ago</p>
            </div>
          </div>
          <div>
            <input type="checkbox" class="all_check1">
          </div>
        </div> -->
      </section>
    </section>

    <section id="all_todo" class="tags">
      for todo list
    </section>


    <footer class="footer">
      <button onclick="moveToOngoing()" style="cursor: pointer;" id="action_btn" class="all_btn btn_stroke">Move To
        ongoing</button>
      <button class="all_btn btn_solid">Export</button>
    </footer>
  </div>



  <!-- comment overlay  -->
  <div class="comment_info" id="comment_info">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div class="nav">
        <div onclick="changeNavOverlay(0)" class="header_listc active_navc">Overview</div>
        <div onclick="changeNavOverlay(1)" class="header_listc">To-do (0)</div>
        <div onclick="changeNavOverlay(2)" class="header_listc">Comments (1)</div>
      </div>
      <div style="padding: 10px;" onclick="commentOverlay(false)">
        <i style="font-size: 16px; color: #7F7979;" class="fa-solid fa-xmark"></i>
      </div>
    </div>


    <div style="color: #7F7979;" class="comment_nav_hide comment_nav">
      <div style="padding:0px 15px; color: #BEBEBE;">
        <p style="padding: 15px 0px;" class="bottom">Create a title (e.g landing page changes)</p>
      </div>

      <div style="padding: 0px 15px;">
        <div style=" padding: 15px 0px; display: flex;" class="bottom">
          <div class="" style="display: flex; align-items: center; gap: 5px; width: 50%;">
            <i class="fa-solid fa-crop-simple"></i>
            <p id="task_page">Landing Page</p>
          </div>

          <div class="" style="display: flex; align-items: center; gap: 5px; width: 50%;">
            <i class="fa-regular fa-file"></i>
            <p>Page 1</p>
          </div>
        </div>

        <div style=" padding: 15px 0px; display: flex;" class="bottom">
          <div class="" style="display: flex; align-items: center; gap: 10px; width: 50%;">
            <img id="task_img" style="height: 28px; width: 28px;  border-radius: 100%;"
              src="https://s3-alpha.figma.com/static/user_p_v2.png" alt="">
            <p id="task_creator">Pelumi</p>
          </div>

          <div class="" style=" display: flex; align-items: center; gap: 5px; width: 50%;">
            <i class="fa-regular fa-circle-check"></i>
            <p id="task_created">Created 4 min ago</p>
          </div>
        </div>

        <div>
          <div class="bottom"
            style=" display: flex; align-items: center; justify-content: space-between; gap: 5px; width: 50%; padding: 15px 0px;">
            <p id="due_date">Add due date</p>
            <i class="fa-regular fa-calendar-days"></i>
            <input type="date">
          </div>
        </div>

        <div class="bottom"
          style="display: flex; align-items: center; gap: 15px; width: 100%; margin-top: 30px; padding: 15px 0px;">
          <i class="fa-regular fa-comment"></i>
          <p>1 Comment</p>
        </div>


        <div class="bottom" style="display: flex; gap: 10px; padding: 15px 0px;">
          <i class="fa-solid fa-list"></i>
          <div style="width: 100%;">
            <p>0/0 To-do completed (0%)</p>
            <div style="width: 100%; background-color: #EBEBF2; height: 4px; margin-top: 10px;"></div>
          </div>
        </div>
      </div>
      <div>
        <button class="all_btn" style="margin-top: 10px; color: #0A99FE;">Add new Tag</button>
      </div>
    </div>



    <div style="padding: 0px 15px;" class="todo comment_nav_hide">
      <div style="padding:0px 15px; color: #BEBEBE;" class="bottom">
        <p style="padding: 15px 0px;">Add a to-do list (e.g add an image)</p>
      </div>

      <div class="bottom" style="padding: 15px 15px 20px 15px;">
        <button class="all_btn btn_solid">Add To-do</button>
      </div>

      <div style="width: 100%; padding: 12px 0px;">
        <p style="color: #7F7979;">0/0 To-do completed (0%)</p>
        <div style="width: 100%; background-color: #EBEBF2; height: 4px; margin-top: 10px;">
          <div style="width: 10%; background-color: #37AE6D; height: 4px;"></div>
        </div>
      </div>

      <div class="todo_list">
        <div style="display: flex; align-items: center; gap: 7px; padding: 13px;" class="bottom">
          <i class="fa-brands fa-figma"></i>
          <p>To-do Items (3)</p>
        </div>
        <div style="padding: 0px 15px;">
          <div class="bottom" style="display: flex; padding: 15px 0px; gap: 8px;">
            <input type="checkbox" name="" id="">
            <p>Find an image on unsplash</p>
          </div>

          <div class="bottom" style="display: flex; padding: 15px 0px; gap: 8px;">
            <input type="checkbox" name="" id="">
            <p>Images must be 1220px by 1000px, landscape.</p>
          </div>
        </div>
      </div>

    </div>


    <div class="comments comment_nav_hide" style="padding: 0px ;">
      <div style="display: flex; justify-content: space-between; padding: 15px;" class="bottom">
        <p>Today</p>
        <p style="color: #BEBEBE;">an hour ago</p>
      </div>
      <div style=" display: flex; gap: 10px;  margin-top: 15px; padding: 0px 15px;">
        <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
          <img style="height: 28px; width: 28px;  border-radius: 100%;"
            src="https://s3-alpha.figma.com/static/user_p_v2.png" alt="">
        </div>
        <div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <p style="font-weight: 500;">Adam</p>
            <span style="color: #BEBEBE;">12.09pm</span>
          </div>

          <p style="margin:8px 0px; color: #7F7979;">For hero section interaction and text scroll please checkout see
            https://inspirux.com/about/ and https://giats.me/</p>
          <!-- <p style="color: #7F7979;">Last comment: 2 mins ago</p> -->
        </div>

      </div>


      <div style="padding: 0px 60px; margin-top: 40px;">
        <input style="width: 100%;" type="text" class="input bottom" placeholder="Type a response" name="" id="">
      </div>


      <footer class="footer">
        <button id="reply_btn" class="all_btn btn_solid">Reply to Figma Thread</button>
      </footer>

    </div>

  </div>
</body>



<script>


  let global_comments
  let global_files
  let comments_withfile
  let userInfo

  let ongoing_tasks
  let selectedTask

  const backend_url = "http://localhost:3030/api/v1"

  <!-- page routing  -->
  function showNextPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'))
    document.getElementById(pageId).classList.add('active')
  }

  function changePage2Nav(num) {
    document.querySelectorAll('.header_list').forEach(nav => nav.classList.remove('active_nav'))
    document.querySelectorAll(".header_list")[num].classList.add('active_nav')


    document.querySelectorAll('.tags').forEach(nav => nav.classList.remove('tag_active'))
    document.querySelectorAll(".tags")[num].classList.add('tag_active')
  }

  function changeNavOverlay(num) {
    document.querySelectorAll('.header_listc').forEach(nav => nav.classList.remove('active_navc'))
    document.querySelectorAll(".header_listc")[num].classList.add('active_navc')
    document.querySelectorAll('.comment_nav_hide').forEach(nav => nav.classList.remove('comment_nav'))
    document.querySelectorAll('.comment_nav_hide')[num].classList.add('comment_nav')
  }


  function commentOverlay(overlayShow) {
    const getOverlay = document.getElementById('comment_info')
    if (overlayShow) {
      getOverlay.classList.add('comment_info_show')
      overlayShow = true
    } else {
      getOverlay.classList.remove('comment_info_show')
      overlayShow = false
    }
  }

  async function getOngoingTasks(user_id, file_id) {
    const res = await fetch(`${backend_url}/get-tasks/${user_id}/${file_id}`, {
      headers: {
        "Content-Type": "application/json",
      },
    })
    ongoing_tasks = await res.json()
    ongoing_tasks = ongoing_tasks.data
    console.log('task', ongoing_tasks)
    loadComments()
    if (ongoing_tasks.length > 1) {
      document.getElementById('page2_sub3').innerHTML = ongoing_tasks.map(c =>
        `<div 
          style="display: flex; justify-content: space-between; padding: 15px;" class="bottom">
          <div onclick="commentOverlay(true), selectTask(${c.figma_id})" style="cursor: pointer; display: flex; gap: 10px;">
            <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
              <img style="height: 28px; width: 28px;  border-radius: 100%;"
                src=${extractDefaultAvatar(c.creator_img)} alt="">
            </div>
            <div>
              <h3 style="font-weight: 500;">${c.comment}</h3>
              <p style="margin:8px 0px; color: #7F7979;">${c.board_name}</p>
              <p style="color: #7F7979;">Last comment: ${dayjs(c.createdOn).format('YYYY-MM-DD h:mm A')}</p>
            </div>
          </div>
          <div>
            <input id=${c.id} class='all_check' type="checkbox">
          </div>
          </div>`).join('')
      const title = document.getElementById('page2_ttt').innerHTML = `Ongoing Tasks (${ongoing_tasks.length})`
    } else {
      document.getElementById('page2_sub3').innerHTML = `<div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">No task on file yet!</p>
        </div>`
    }
  }

  async function loadComments() {
    let filter = comments_withfile.filter(obj =>
      !ongoing_tasks.some(obj1 => obj.id === obj1.figma_id)
    );
    filter = filter.filter(c => c.parent_id === "")
    console.log('filter', filter)
    if (filter.length > 1) {
      document.getElementById('page2_sub2').innerHTML = filter.map(c =>
        `<div 
          style="display: flex; justify-content: space-between; padding: 15px;" class="bottom">
          <div  style="cursor: pointer; display: flex; gap: 10px;">
            <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
              <img style="height: 28px; width: 28px;  border-radius: 100%;"
                src=${extractDefaultAvatar(c.user.img_url)} alt="">
            </div>
            <div>
              <h3 style="font-weight: 500;">${c.message}</h3>
              <p style="margin:8px 0px; color: #7F7979;">${c.board_name}</p>
              <p style="color: #7F7979;">Last comment: ${dayjs(c.created_at).format('YYYY-MM-DD h:mm A')}</p>
            </div>
          </div>
          <div>
            <input id=${c.id} class='all_check' type="checkbox">
          </div>
          </div>`).join('')
      const title = document.getElementById('page2_tt').innerHTML = `Backlog (${filter.filter(c => c.parent_id === "").length})`
    } else {
      document.getElementById('page2_sub2').innerHTML = `<div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">No comment on backlog!</p>
        </div>`
    }
  }

  window.onmessage = (event) => {

    if (event.data.pluginMessage?.type === 'idd') {
      const fileId = event.data.pluginMessage.data;
    }

    if (event.data.pluginMessage.type === "get-comment") {
      global_comments = event.data.pluginMessage.data.comments;
    }

    if (event.data.pluginMessage.type === "get-user") {
      userInfo = event.data.pluginMessage.data;
      async function createUser() {
        const res = await fetch(`${backend_url}/create-user`, {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
          body: JSON.stringify({
            figma_id: userInfo.id,
            figma_email: userInfo.email,
            figma_handle: userInfo.handle,
            figma_image: userInfo.img_url
          }),
        })
      }
      createUser()
    }

    if (event.data.pluginMessage.type === "get-files") {
      global_files = event.data.pluginMessage.data.document.children[0].children
      comments_withfile = global_comments.map(item1 => {
        const match = global_files.find(item2 => item2.id === item1.client_meta?.node_id);
        return { ...item1, board_name: match ? match.name : null };
      });

      async function createFile() {
        const res = await fetch(`${backend_url}/create-file`, {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
          body: JSON.stringify({
            figma_file_id: "eNDMTZhqPS1wYSkLMSaovC",
            figma_file_key: "eNDMTZhqPS1wYSkLMSaovC",
            figma_name: event.data.pluginMessage.data.name,
            user_email: userInfo.email
          }),
        })

      }

      createFile()
      getOngoingTasks(userInfo.id, "eNDMTZhqPS1wYSkLMSaovC")

    }
  };

  function check_comments() {
    const getCheck = document.getElementById('check1')
    if (getCheck.checked) {
      document.querySelectorAll('.all_check').forEach(c => c.checked = true)
    } else {
      document.querySelectorAll('.all_check').forEach(c => c.checked = false)
    }
  }

  function check_ongoing() {
    const getCheck = document.getElementById('check11')
    if (getCheck.checked) {
      document.querySelectorAll('.all_check1').forEach(c => c.checked = true)
    } else {
      document.querySelectorAll('.all_check1').forEach(c => c.checked = false)
    }
  }

  function moveToOngoing() {
    const get_checked = document.querySelectorAll('.all_check');
    console.log(get_checked);

    const send = [];

    get_checked.forEach(checkbox => {
      if (checkbox.checked) {
        send.push(checkbox);
      }
    });
    const getCheckedComms = comments_withfile.filter(obj =>
      send.some(obj1 => obj.id === obj1.id)
    );
    console.log(getCheckedComms);

    async function createTask() {
      const res = await fetch(`${backend_url}/create-task`, {
        headers: {
          "Content-Type": "application/json",
        },
        method: "POST",
        body: JSON.stringify(getCheckedComms.flat().map((comms) => ({
          message: comms.message,
          figma_id: comms.id,
          figma_order_id: comms.order_id,
          figma_uuid: comms.uuid,
          board_name: comms.board_name,
          board_number: "",
          file_key: comms.file_key,
          user_id: userInfo.id,
          figma_createdOn: comms.created_at,
          creator_img: comms.user.img_url,
          creator_name: comms.user.handle
        }))),
      })
      await getOngoingTasks(userInfo.id, "eNDMTZhqPS1wYSkLMSaovC")
      await loadComments()

    }
    createTask()
  }

  function extractDefaultAvatar(url) {
    const match = url.match(/default=([^&]+)/);
    return match ? decodeURIComponent(match[1]) : url;
  }

  function selectTask(taskId) {
    selectedTask = ongoing_tasks.find(obj => obj.figma_id === `${taskId}`)
    document.getElementById('task_page').innerHTML = selectedTask.board_name
    document.getElementById('task_img').src = extractDefaultAvatar(selectedTask.creator_img)
    document.getElementById('task_created').innerHTML = dayjs(selectedTask.createdOn).format('YYYY-MM-DD h:mm A')
    document.getElementById('task_creator').innerHTML = selectedTask.creator_name

    if (selectedTask.due_date !== null) {
      document.getElementById('due_date').innerHTML = dayjs(selectedTask.due_date).format('YYYY-MM-DD h:mm A')
    }

  }

</script>

</html>