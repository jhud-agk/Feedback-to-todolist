<!--  -->

<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">
  <link rel="" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./styles.css">
  <!-- <script src="https://kit.fontawesome.com/0d24a6d486.js" crossorigin="anonymous"></script> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- <i class="fa-solid fa-circle-check"></i> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
</head>

<style>
  * {
    padding: 0;
    margin: 0;
    font-size: 12px;
  }

  body {
    font-family: 'inter';
  }

  .signup_input {
    outline: none;
    width: 100%;
    padding: 8px;

  }

  .black_bg {
    position: fixed;
    background-color: #00000057;
    height: 100%;
    width: 100%;
    left: 0;
    top: 0px;
    display: block !important;
    z-index: 5;
  }

  .task_todo_l:not(:first-child) {
    margin-top: 10px;
  }

  .signup_input::placeholder {
    color: #BEBEBE;
  }

  .page,
  .comment_nav_hide,
  .tags {
    display: none;
  }

  .active,
  .comment_nav,
  .tag_active {
    display: block;
  }

  .all_btn {
    outline: none;
    border: none;
    padding: 10px 20px;
    background-color: transparent;
  }

  .btn_solid {
    background-color: #0A99FE;
    color: white;
  }

  .btn_stroke {
    color: #0A99FE;
    border: #0A99FE solid 1px;
    background-color: transparent;
  }

  .first_page {
    padding: 25px;
    border-top: 1px solid #EBEBF2;
    margin-top: 50px;
  }

  .nav {
    display: flex;
    border-bottom: 1px solid #EBEBF2;
  }

  .active_nav,
  .active_navc {
    border-bottom: 1px solid #1E1E1E;
    color: #1E1E1E !important;
  }

  .header_list,
  .header_listc {
    cursor: pointer;
  }

  .nav div {
    color: #BEBEBE;
    padding: 12px 0px 12px 17px;
  }

  .search_con {
    padding: 15px;
    background-color: #FAFAFA;
    border-bottom: 1px solid #EBEBF2;
  }

  .search {
    display: flex;
    align-items: center;
    border: #EBEBF2 solid 1px;
    padding: 2px;
  }

  .input {
    outline: none;
    padding: 10px;
    border: none;
    width: 100%;
  }

  .input::placeholder {
    color: #BEBEBE;
  }

  .footer {
    display: flex;
    gap: 10px;
    justify-content: end;
    padding: 15px;
    border-top: 1px solid #EBEBF2;
    bottom: 0px;
    width: 93%;
    background-color: white;
  }

  .bottom {
    border-bottom: 1px solid #EBEBF2;
  }

  .comment_info {
    position: absolute;
    width: 100%;
    height: 100vh;
    background: white;
    height: 100%;
    transition: all 0.6s;
    top: 700px;
    z-index: 7;
  }

  .comment_info_show {
    top: 30px !important;
    display: block;
  }

  .todo_list {
    border: 1px solid #EBEBF2;
    border-radius: 5px;
  }

  .strike {
    text-decoration: line-through;
  }
</style>


<body style="overflow: hidden;">

  <!-- Page 1 -->
  <div id="page1" class="first_page page active">
    <h3 style="font-weight: 600; margin-top: 40px;">Import Figma Comments</h3>
    <p style="margin-top: 10px; color: #7F7979;">Connecting your Figma will allow you easily filter/ Search all your
      Figma comments and
      more. you can add custom
      statuses, to-do-list, due dates and much more, you will only need to do this once per Figma file.</p>
    <input style="margin-top: 10px;" placeholder="Enter your access token" type="text" class="signup_input" name=""
      id="access_id">
    <button onclick="getAccessToken()" class="all_btn btn_solid" style="margin-top: 30px;">Connect This Figma
      File</button>
  </div>

  <!-- page 2  -->
  <div style="height: 100%; overflow-x: scroll; padding: 15px;" id="page2" class="page ">
    <ul style="list-style: decimal; padding: 15px;">
      <div>
        <li>Click <span style="font-weight: 600;">Share</span> on this figma file.</li>
        <img style="margin-top: 13px;" loading="lazy"
          src="https://res.cloudinary.com/dgrrpoejk/image/upload/v1740042857/others/image2_kppvw0.svg" alt="">
      </div>

      <div style="margin-top: 20px;">
        <li>Click on <span style="font-weight: 600;">copy link</span> at the button of the pop up.</li>
        <img style="margin-top: 13px;" loading="lazy"
          src="https://res.cloudinary.com/dgrrpoejk/image/upload/v1740042856/others/image_vylpxp.svg" alt="">
      </div>

      <div style="margin-top: 20px;">
        <li><span style="font-weight: 600;">Paste</span>Figma link below, and <span
            style="font-weight: 600;">save</span> to continue.</li>
        <input style="margin-top: 10px;" placeholder="eg. https://www.figma.com/design/eNDMTZhq...." type="text"
          class="signup_input" name="" id="link_id">
      </div>
      <button style="margin-top: 10px;" onclick="getFileLink()" class="all_btn btn_solid">Save URL</button>
    </ul>

  </div>

  <!-- page 3  -->
  <div style="height: 100%; overflow-x: scroll;" id="page3" class="page ">
    <div class="nav">
      <div onclick="changePage2Nav(0), commentOverlay(false)" class="header_list active_nav">Figma Comments</div>
      <div onclick="changePage2Nav(1)" class="header_list">Ongoing Tasks</div>
      <div onclick="changePage2Nav(2), commentOverlay(false)" class="header_list">My To-do List</div>
    </div>

    <div class="search_con">
      <div class="search">
        <i style="font-size: 20px; color: #BEBEBE; padding-left: 15px;" class="fa-solid fa-magnifying-glass"></i>
        <input class="input" type="text" placeholder="Search a comment or keyword ...">
        <img src="/assets/search.svg" alt="">
      </div>
    </div>

    <!-- for all comments -->
    <section id="all_comments" class="tags tag_active">
      <section id="page2_sub1" class="page2_sub bottom"
        style="display: flex; align-items: center; justify-content: space-between; padding: 15px;">
        <div class="" style="display: flex; align-items: center; font-weight: 500; gap: 8px;">
          <i class="fa-brands fa-figma"></i>
          <p id="page2_tt">Backlog (0)</p>
        </div>
        <div>
          <input onchange="check_comments()" id="check1" type="checkbox">
        </div>
      </section>

      <section id="page2_sub2" style="margin-bottom: 80px;" class="page2_sub">
        <div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">Loading comments...</p>
        </div>
      </section>

      <footer style="position: fixed;" class="footer">
        <button onclick="moveToOngoing()" style="cursor: pointer;" id="action_btn" class="all_btn btn_stroke">Move To
          ongoing</button>
        <button onclick="exportOverlay(true)" class="all_btn btn_solid">Export</button>
      </footer>
    </section>

    <!-- for ongoing  -->
    <section id="all_ongoing" class="tags">
      <section id="page2_sub1" class="page2_sub bottom"
        style="display: flex; align-items: center; justify-content: space-between; padding: 15px;">
        <div class="" style="display: flex; align-items: center; font-weight: 500; gap: 8px;">
          <i class="fa-brands fa-figma"></i>
          <p id="page2_ttt">Ongoing Tasks (0)</p>
        </div>
        <div>
          <input onchange="check_ongoing()" id="check11" type="checkbox">
        </div>
      </section>

      <section id="page2_sub3" style="margin-bottom: 80px;" class="page2_sub">
        <div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">Loading tasks...</p>
        </div>
        <!-- <div style="display: flex; justify-content: space-between; padding: 15px;" class="bottom">
          <div onclick="showNextPage('page3'), changePage2Nav(3)" style="cursor: pointer; display: flex; gap: 10px;">
            <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
              <img style="height: 28px; width: 28px;  border-radius: 100%;"
                src="https://s3-alpha.figma.com/static/user_p_v2.png" alt="">
            </div>
            <div>
              <h3 style="font-weight: 500;">For hero section interaction and text scroll see ...</h3>
              <p style="margin:8px 0px; color: #7F7979;">Landing page</p>
              <p style="color: #7F7979;">Last comment: 2 mins ago</p>
            </div>
          </div>
          <div>
            <input type="checkbox" class="all_check1">
          </div>
        </div> -->
      </section>

      <footer style="position: fixed;" class="footer">
        <button onclick="moveToComplete()" style="cursor: pointer;" id="action_btn" class="all_btn btn_stroke">Mark as
          complete</button>
        <button class="all_btn btn_solid">Export</button>
      </footer>
    </section>


    <!-- all file todo for user -->
    <section id="all_todo" class="tags" style="padding: 15px;">
      <!-- <div class="todo_list">
        <div style="padding: 10px;" class="bottom">
          <p style="font-weight: 600;">Title of the comment goes in here</p>
          <p style="color: #F76063;">Due 2 days ago</p>
          <div id="todoBar" style="width: 100%; background-color: #EBEBF2; height: 4px; margin: 10px 0px;">
            <div style="width: 10%; background-color: #37AE6D; height: 4px;"></div>
          </div>
          <p id="" style="color: #7F7979;">0/0 To-do completed (0%)</p>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 15px;">
          <input type="text" style="width: 70%;" placeholder="Add a to-do list (e.g add an image)" class="input bottom"
            name="" id="">
          <button class="all_btn" style="color: #BEBEBE; padding: 1px 10px; border: #BEBEBE solid 1px;">Add
            To-do</button>
        </div>
        <div class="">
          <div id="todosss" style="padding: 0px 15px;">
            <div class="bottom" style="display: flex; padding: 15px 0px; gap: 8px;">
              <input type="checkbox" name="" id="">
              <p>Images must be 1220px by 1000px, landscape.</p>
            </div>
          </div>
        </div>
      </div> -->
      <!-- <div class="todo_list">
        <div style="display: flex; align-items: center; gap: 7px; padding: 13px;" class="bottom">
          <i class="fa-brands fa-figma"></i>
          <p id="todoLen">Title of the comment goes in here</p>
        </div>
        <div id="todosss" style="padding: 0px 15px;">
          <div class="bottom" style="display: flex; padding: 15px 0px; gap: 8px;">
            <input type="checkbox" name="" id="">
            <p>Images must be 1220px by 1000px, landscape.</p>
          </div>
        </div>
      </div> -->
    </section>
  </div>

  <!-- comment overlay  -->
  <div id="bg_overlay" class="page"></div>
  <div class="comment_info" id="comment_info">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div class="nav">
        <div onclick="changeNavOverlay(0)" class="header_listc active_navc">Overview</div>
        <div id="todo_nav" onclick="changeNavOverlay(1)" class="header_listc">To-do (0)</div>
        <div onclick="changeNavOverlay(2)" id="comment_no" class="header_listc">Comments (1)</div>
      </div>
      <div style="padding: 10px;" onclick="commentOverlay(false)">
        <i style="font-size: 16px; color: #7F7979;" class="fa-solid fa-xmark"></i>
      </div>
    </div>

    <div style="color: #7F7979;" class="comment_nav_hide comment_nav">
      <div style="padding:0px 15px; color: #3f3f3f;">
        <p style="padding: 15px 0px;" id="comment" class="bottom">Create a title (e.g landing page changes)</p>
      </div>

      <div style="padding: 0px 15px;">
        <div style=" padding: 15px 0px; display: flex;" class="bottom">
          <div class="" style="display: flex; align-items: center; gap: 5px; width: 50%;">
            <i class="fa-solid fa-crop-simple"></i>
            <p id="task_page">Landing Page</p>
          </div>

          <div class="" style="display: flex; align-items: center; gap: 5px; width: 50%;">
            <i class="fa-regular fa-file"></i>
            <p>Page 1</p>
          </div>
        </div>

        <div style=" padding: 15px 0px; display: flex;" class="bottom">
          <div class="" style="display: flex; align-items: center; gap: 10px; width: 50%;">
            <img id="task_img" style="height: 28px; width: 28px;  border-radius: 100%;"
              src="https://s3-alpha.figma.com/static/user_p_v2.png" alt="">
            <p id="task_creator">Pelumi</p>
          </div>

          <div class="" style=" display: flex; align-items: center; gap: 5px; width: 50%;">
            <i class="fa-regular fa-circle-check"></i>
            <p id="task_created">Created 4 min ago</p>
          </div>
        </div>

        <div>
          <div class="bottom"
            style=" display: flex; align-items: center; justify-content: space-between; gap: 5px; width: 50%; padding: 15px 0px;">
            <p id="due_date">Add due date</p>
            <i class="fa-regular fa-calendar-days"></i>
            <input onchange="addDueDate(this)" type="date" id="dateInput">
          </div>
        </div>

        <div class="bottom"
          style="display: flex; align-items: center; gap: 15px; width: 100%; margin-top: 30px; padding: 15px 0px;">
          <i class="fa-regular fa-comment"></i>
          <p id="t_comment">1 Comment</p>
        </div>

        <div class="bottom" style="display: flex; gap: 10px; padding: 15px 0px;">
          <i class="fa-solid fa-list"></i>
          <div style="width: 100%;">
            <p id="todoCom"></p>
            <div id="todoBar" style="width: 100%; background-color: #EBEBF2; height: 4px; margin-top: 10px;">
              <div style="width: 10%; background-color: #37AE6D; height: 4px;"></div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <button onclick="showTags([])" id="show_tag_btn" class="all_btn" style="margin-top: 10px; color: #0A99FE;">Add
          new
          Tag</button>
        <div id="show_tags" style="padding: 15px;" class="tags">
          <div style="display: flex; border: solid 2px #7F7979; padding: 5px; flex-wrap: wrap;" class="">
            <div id="tag_con" style="display: flex; gap: 5px; flex-wrap: wrap;">
            </div>
            <input id="tagInput" type="text" class="input" placeholder="type here">
          </div>
        </div>
      </div>
    </div>

    <div style="padding: 0px 15px;" class="todo comment_nav_hide">
      <div style="padding:0px 15px; color: #BEBEBE;" class="bottom">
        <input id="todoInput" style="padding: 15px 0px;" class="input"
          placeholder="Add a to-do list (e.g add an image)" />
      </div>

      <div class="bottom" style="padding: 15px 15px 20px 15px;">
        <button onclick="createTodo('todoInput', selectedTask.figma_id)" class="all_btn btn_solid">Add To-do</button>
      </div>

      <div style="width: 100%; padding: 12px 0px;">
        <p id="todoCom1" style="color: #7F7979;">0/0 To-do completed (0%)</p>
        <div id="todoBar1" style="width: 100%; background-color: #EBEBF2; height: 4px; margin-top: 10px;">
        </div>
      </div>

      <div class="todo_list">
        <div style="display: flex; align-items: center; gap: 7px; padding: 13px;" class="bottom">
          <i class="fa-brands fa-figma"></i>
          <p id="todoLen1">To-do Items (0)</p>
        </div>
        <div id="todos" style="padding: 0px 15px;">
          <!-- <div class="bottom" style="display: flex; padding: 15px 0px; gap: 8px;">
            <input type="checkbox" name="" id="">
            <p>Images must be 1220px by 1000px, landscape.</p>
          </div> -->
        </div>
      </div>


    </div>


    <div class="comments comment_nav_hide" style="padding: 0px ;">
      <div style="display: flex; justify-content: space-between; padding: 15px;" class="bottom">
        <p>Today</p>
        <p style="color: #BEBEBE;">an hour ago</p>
      </div>

      <div id="child_comments">
        <div style=" display: flex; gap: 10px;  margin-top: 15px; padding: 0px 15px;">
          <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
            <img style="height: 28px; width: 28px;  border-radius: 100%;"
              src="https://s3-alpha.figma.com/static/user_p_v2.png" alt="">
          </div>
          <div>
            <div style="display: flex; align-items: center; gap: 5px;">
              <p style="font-weight: 500;">Adam</p>
              <span style="color: #BEBEBE;">12.09pm</span>
            </div>
            <p style="margin:8px 0px; color: #7F7979;">For hero section interaction and text scroll please checkout see
              https://inspirux.com/about/ and https://giats.me/</p>
            <!-- <p style="color: #7F7979;">Last comment: 2 mins ago</p> -->
          </div>
        </div>
      </div>

      <div style="padding: 0px 60px; margin-top: 40px;">
        <input style="width: 100%;" type="text" class="input bottom" placeholder="Type a response" name=""
          id="add_comment">
      </div>

      <footer style="position: fixed;" class="footer">
        <button onclick="addComment()" id="reply_btn" class="all_btn btn_solid">Reply to Figma Thread</button>
      </footer>

    </div>

  </div>

  <!-- export overlay  -->'

  <div id="figma_overlay" class="comment_info">
    <div style="height: 95%; width: 100%; display: flex; flex-direction: column; justify-content: space-between;">
      <div>
        <div style="display: flex; justify-content: space-between;">
          <p style="padding: 15px;" class="bottom">Export Tasks</p>
          <div style="padding: 10px;" onclick="exportOverlay(false)">
            <i style="font-size: 16px; color: #7F7979;" class="fa-solid fa-xmark"></i>
          </div>
        </div>

        <div style="padding: 15px;">
          <div style="display: flex; gap: 7px;">
            <input type="checkbox" id="export">
            <label for="jira">Jira</label>
          </div>
          <div style="display: flex; gap: 7px; margin-top: 10px;">
            <input type="checkbox" id="export">
            <label for="trello">Trello</label>
          </div>
          <div style="display: flex; gap: 7px; margin-top: 10px;">
            <input type="checkbox" id="export">
            <label for="pdf">PDF</label>
          </div>
          <div style="display: flex; gap: 7px; margin-top: 10px;">
            <input type="checkbox" id="export">
            <label for="json">JSON/ CSV</label>
          </div>
        </div>
      </div>

      <footer class="footer">
        <button onclick="exportOverlay(true)" id="reply_btn" class="all_btn btn_solid">Export</button>
      </footer>

    </div>
  </div>
</body>


<script>


  let global_comments
  let global_files
  let comments_withfile
  let userInfo


  let ongoing_tasks
  let selectedTask
  let taskTodo

  let fileId

  const backend_url = "http://localhost:3030/api/v1"

  // page routing
  function showNextPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'))
    document.getElementById(pageId).classList.add('active')
  }

  function changePage2Nav(num) {
    document.querySelectorAll('.header_list').forEach(nav => nav.classList.remove('active_nav'))
    document.querySelectorAll(".header_list")[num].classList.add('active_nav')
    document.querySelectorAll('.tags').forEach(nav => nav.classList.remove('tag_active'))
    document.querySelectorAll(".tags")[num].classList.add('tag_active')
  }

  function changeNavOverlay(num) {
    document.querySelectorAll('.header_listc').forEach(nav => nav.classList.remove('active_navc'))
    document.querySelectorAll(".header_listc")[num].classList.add('active_navc')
    document.querySelectorAll('.comment_nav_hide').forEach(nav => nav.classList.remove('comment_nav'))
    document.querySelectorAll('.comment_nav_hide')[num].classList.add('comment_nav')
  }

  function getAccessToken() {
    const access_token = document.getElementById('access_id').value
    parent.postMessage({ pluginMessage: { type: 'access_token', data: access_token } }, "*")
  }

  function getFileLink() {
    const file_link = document.getElementById('link_id').value
    parent.postMessage({ pluginMessage: { type: 'comments', data: getFigmaFileKey(file_link) } }, "*")
    parent.postMessage({ pluginMessage: { type: 'file_id', data: getFigmaFileKey(file_link) } }, "*")
  }


  function showTags(tags) {
    document.getElementById("show_tag_btn").classList.add('tags')
    document.getElementById('show_tags').classList.remove('tags')
    if (tags.length > 0) {
      document.getElementById('tag_con').innerHTML = tags.map(obj => `
              <div
                style="background-color: #0A99FE; color: white; padding: 5px 15px; display: flex; align-items: center; gap: 4px;">
                <p>${obj}</p>
                <i onclick="addTag('${obj}')" style="font-size: 14px;" class="fa-solid fa-xmark"></i>
              </div>
          `).join('')
    } else {
      document.getElementById('tag_con').innerHTML = ''
    }
  }

  //fetch ongoing  tasks and load it
  async function getOngoingTasks(user_id, file_id) {
    const res = await fetch(`${backend_url}/get-tasks/${user_id}/${file_id}`, {
      headers: {
        "Content-Type": "application/json",
      },
    })
    ongoing_tasks = await res.json()
    ongoing_tasks = ongoing_tasks.data
    console.log('task', ongoing_tasks)
    loadComments()
    if (ongoing_tasks.length > 0) {
      const all = ongoing_tasks.filter(obj => obj.is_resolved === false)
      document.getElementById('page2_sub3').innerHTML = all.map(c =>
        `<div 
          style="display: flex; justify-content: space-between; padding: 15px;" class="bottom">
          <div onclick="commentOverlay(true), selectTask(${c.figma_id})" style="cursor: pointer; display: flex; gap: 10px;">
            <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
              <img style="height: 28px; width: 28px;  border-radius: 100%;"
                src=${extractDefaultAvatar(c.creator_img)} alt="">
            </div>
            <div>
              <h3 style="font-weight: 500;">${c.comment}</h3>
              <p style="margin:8px 0px; color: #7F7979;">${c.board_name}</p>
              <p style="color: #7F7979;">Last comment: ${dayjs(c.createdOn).format('YYYY-MM-DD h:mm A')}</p>
            </div>
          </div>
          <div>
            <input id=${c.id} class='all_check1' type="checkbox">
          </div>
          </div>`).join('')
      const title = document.getElementById('page2_ttt').innerHTML = `Ongoing Tasks (${ongoing_tasks.length})`

      document.getElementById('all_todo').innerHTML = all.map(c => {
        const resolved = c.todos.filter(obj => obj.is_resolved === true)
        const not_resolved = c.todos.filter(obj => obj.is_resolved === false)
        let percent = 0
        if (c.todos.length > 0) {
          percent = (resolved.length / c.todos.length) * 100
        }
        return `
        <div class="todo_list task_todo_l">
        <div style="padding: 10px;" class="bottom ">
          <p style="font-weight: 600;">${c.comment}</p>
          <p style="color: #F76063;">Due 2 days ago</p>
          <div style="width: 100%; background-color: #EBEBF2; height: 4px; margin: 10px 0px;">
            <div style="width: ${percent}%; background-color: #37AE6D; height: 4px;"></div>
          </div>
          <p style="color: #7F7979;">${resolved.length}/${c.todos.length} To-do completed (${formatNumber(percent)}%)</p>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0px 15px;">
          <input id="${c.figma_id}input" type="text" style="width: 70%;" placeholder="Add a to-do list (e.g add an image)" class="input bottom">
          <button onclick="createTodo('${c.figma_id}input', '${c.figma_id}')" class="all_btn" style="color: #BEBEBE; padding: 1px 10px; border: #BEBEBE solid 1px;">Add To-do</button>
        </div>
        <div style="padding: 0px 15px;">
          ${c.todos.map(td => `
            <div class="bottom" style="display: flex; padding: 10px 0px; gap: 8px;">
            <input  onclick="updateTodo('${td.id}')" type="checkbox" ${td.is_resolved ? "checked" : ""}>
              <p data-uuid="${td.id}" class="${td.is_resolved ? "strike" : ""}">${td.todo}</p>
            </div>
          `).join('')}
        </div>
      </div>
    `
      }).join('')
    } else {
      document.getElementById('page2_sub3').innerHTML = `<div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">No task on file yet!</p>
        </div>`
      document.getElementById('all_todo').innerHTML = `<div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">No task on file yet!</p>
        </div>`
    }
  }

  // load all comment from figma
  async function loadComments() {
    let filter = comments_withfile.filter(obj =>
      !ongoing_tasks.some(obj1 => obj.id === obj1.figma_id)
    );
    filter = filter.filter(c => c.parent_id === "")
    console.log('filter', filter)
    if (filter.length > 0) {
      document.getElementById('page2_sub2').innerHTML = filter.map(c =>
        `<div 
          style="display: flex; justify-content: space-between; padding: 15px;" class="bottom">
          <div  style="cursor: pointer; display: flex; gap: 10px;">
            <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
              <img style="height: 28px; width: 28px;  border-radius: 100%;"
                src=${extractDefaultAvatar(c.user.img_url)} alt="">
            </div>
            <div>
              <h3 style="font-weight: 500;">${c.message}</h3>
              <p style="margin:8px 0px; color: #7F7979;">${c.board_name}</p>
              <p style="color: #7F7979;">Last comment: ${dayjs(c.created_at).format('YYYY-MM-DD h:mm A')}</p>
            </div>
          </div>
          <div>
            <input id=${c.id} class='all_check' type="checkbox">
          </div>
          </div>`).join('')
      const title = document.getElementById('page2_tt').innerHTML = `Backlog (${filter.filter(c => c.parent_id === "").length})`
    } else {
      document.getElementById('page2_sub2').innerHTML = `<div>
          <p style="text-align: center; margin-top: 20px; font-weight: 700;">No comment on backlog!</p>
        </div>`
    }
  }

  // create todo
  async function createTodo(id, taskId) {
    console.log(id)
    const todoInput = document.getElementById(id)
    if (todoInput.value.length > 3) {
      const res = await fetch(`${backend_url}/create-todo`, {
        headers: {
          "Content-Type": "application/json",
        },
        method: "POST",
        body: JSON.stringify({
          todo: todoInput.value,
          task_id: taskId,
          user_id: userInfo.figma_id,
          file_id: fileId,
        }),
      })
      const todo = await res.json()
      todoInput.value = ''
      fetchTasksTodo()
      await getOngoingTasks(userInfo.id, fileId)
      // fetchFileTodo()
    }
  }

  // fecth todo and change status
  async function fetchTasksTodo() {
    // const res = await fetch(`${backend_url}/get-todo-task/${selectedTask.id}`, {
    //  headers: {
    //   "Content-Type": "application/json",
    //  },
    // })
    // const data = await res.json()
    taskTodo = ongoing_tasks.find(obj => obj.id === selectedTask.id).todos
    console.log(taskTodo)
    // document.getElementById('todoLen').innerHTML = `To-do Items (${taskTodo.length})`

    document.getElementById('todos').innerHTML = taskTodo.map(obj => `
    <div class="bottom" style="display: flex; padding: 15px 0px; gap: 8px;">
      <div onclick="updateTodo('${obj.id}', 'task')"><input type="checkbox" ${obj.is_resolved ? "checked" : ""}></div>
      <p data-uuid="${obj.id}" class=${obj.is_resolved ? "strike" : ""}>${obj.todo}</p>
    </div>
    `).join("");

    const resolved = taskTodo.filter(obj => obj.is_resolved === true)
    const not_resolved = taskTodo.filter(obj => obj.is_resolved === false)
    let percent = 0
    if (taskTodo.length > 0) {
      percent = (resolved.length / taskTodo.length) * 100
    }
    document.getElementById('todoLen1').innerHTML = `To-do Items (${not_resolved.length})`
    document.getElementById("todo_nav").innerHTML = `To-do (${not_resolved.length})`
    document.getElementById('todoCom').innerHTML = `${resolved.length}/${taskTodo.length} To-do completed (${percent !== 0 ? formatNumber(percent) : '0'})%`
    document.getElementById('todoBar').innerHTML = `<div style="width: ${percent}%; background-color: #37AE6D; height: 4px;"></div>`
    document.getElementById('todoCom1').innerHTML = `${resolved.length}/${taskTodo.length} To-do completed (${percent !== 0 ? formatNumber(percent) : '0'})%`
    document.getElementById('todoBar1').innerHTML = `<div style="width: ${percent}%; background-color: #37AE6D; height: 4px;"></div>`
  }

  let checkedTodo
  async function updateTodo(id, where) {
    checkedTodo = id
    console.log(checkedTodo)
    await changeTodoStatus(checkedTodo)
    const todo = document.querySelector(`[data-uuid="${checkedTodo}"]`).classList;
    await getOngoingTasks(userInfo.id, fileId)
    await fetchTasksTodo()
    // if (todo.contains('strike')) {
    // todo.remove('strike')
    // } else {
    // todo.add('strike')
    //}
  }
  async function changeTodoStatus(todoid) {
    const res = await fetch(`${backend_url}/change-todo-status`, {
      headers: {
        "Content-Type": "application/json",
      },
      method: "PATCH",
      body: JSON.stringify({
        todo_id: todoid,
        user_id: userInfo.id
      }),
    })
  }

  // fetch file todos
  async function fetchFileTodo() {
    const res = await fetch(`${backend_url}/get-todo-file/${fileId}/${userInfo.id}`, {
      headers: {
        "Content-Type": "application/json",
      },
    })
    const data = await res.json()
    document.getElementById('todosss').innerHTML = data.data.map(obj => `<div class="bottom" style="display: flex; padding: 15px 0px; gap: 8px;">
            <input onclick="updateTodo('${obj.id}', 'file')" type="checkbox" name="" id="" ${obj.is_resolved ? "checked" : ""}>
            <p data-uuid="${obj.id}1" class=${obj.is_resolved ? "strike" : ""}>${obj.todo}</p>
          </div>`).join('')
  }

  // add tag
  async function addTag(tag) {
    const res = await fetch(`${backend_url}/add-tag`, {
      headers: {
        "Content-Type": "application/json",
      },
      method: "POST",
      body: JSON.stringify({
        tag,
        task_figma_id: selectedTask.figma_id,
        user_figma_id: userInfo.id
      }),
    })
    const tags = await res.json()
    showTags(tags.data)
  }

  document.getElementById('tagInput').addEventListener('keydown', function (event) {
    if (event.target.value.trim().length > 0) {
      if (event.key === " " || event.key === "Enter") {
        event.preventDefault();
        addTag(event.target.value)
        event.target.value = ''
      }
    } else {
      console.log('Tag empty')
    }
  })

  // show comments 
  function commentOverlay(overlayShow) {
    const getOverlay = document.getElementById('comment_info')
    const bg_overlay = document.getElementById("bg_overlay")
    if (overlayShow) {
      getOverlay.classList.add('comment_info_show')
      bg_overlay.classList.add('black_bg')
    } else {
      getOverlay.classList.remove('comment_info_show')
      bg_overlay.classList.remove('black_bg')
      changeNavOverlay(0)
    }
  }

  // show export
  function exportOverlay(overlayShow) {
    const overlay = document.getElementById('figma_overlay')
    const bg_overlay = document.getElementById("bg_overlay")
    if (overlayShow) {
      overlay.classList.add('comment_info_show')
      bg_overlay.classList.add('black_bg')
      overlayShow = true
    } else {
      overlay.classList.remove('comment_info_show')
      bg_overlay.classList.remove('black_bg')
      overlayShow = false
    }
  }



  function check_comments() {
    const getCheck = document.getElementById('check1')
    if (getCheck.checked) {
      document.querySelectorAll('.all_check').forEach(c => c.checked = true)
    } else {
      document.querySelectorAll('.all_check').forEach(c => c.checked = false)
    }
  }

  function check_ongoing() {
    const getCheck = document.getElementById('check11')
    if (getCheck.checked) {
      document.querySelectorAll('.all_check1').forEach(c => c.checked = true)
    } else {
      document.querySelectorAll('.all_check1').forEach(c => c.checked = false)
    }
  }

  function moveToOngoing() {
    const get_checked = document.querySelectorAll('.all_check');
    const send = [];
    get_checked.forEach(checkbox => {
      if (checkbox.checked) {
        send.push(checkbox);
      }
    });
    const getCheckedComms = comments_withfile.filter(obj =>
      send.some(obj1 => obj.id === obj1.id)
    );
    async function createTask() {
      const res = await fetch(`${backend_url}/create-task`, {
        headers: {
          "Content-Type": "application/json",
        },
        method: "POST",
        body: JSON.stringify(getCheckedComms.flat().map((comms) => ({
          message: comms.message,
          figma_id: comms.id,
          figma_order_id: comms.order_id,
          figma_uuid: comms.uuid,
          board_name: comms.board_name,
          board_number: "",
          file_key: comms.file_key,
          user_id: userInfo.id,
          figma_createdOn: comms.created_at,
          creator_img: comms.user.img_url,
          creator_name: comms.user.handle
        }))),
      })
      await getOngoingTasks(userInfo.id, fileId)
      await loadComments()
    }
    createTask()
  }

  function moveToComplete() {
    const get_checked = document.querySelectorAll('.all_check1')
    const checked = []
    get_checked.forEach(checks => {
      if (checks.checked) {
        checked.push(checks)
      }
    })
    console.log('see', userInfo)
    async function completeTask() {
      const res = await fetch(`${backend_url}/change-status`, {
        headers: {
          "Content-Type": "application/json",
        },
        method: "PATCH",
        body: JSON.stringify(checked.flat().map((comms) => ({
          user_id: userInfo.id,
          task_id: comms.id
        }))),
      })
      await getOngoingTasks(userInfo.id, fileId)
      const data = await res.json()
      console.log(data)
    }
    completeTask()
  }


  // adding comments to figma tasks
  let comment_parent_id
  function getTaskComment(taskId) {
    const getParent = global_comments.find(obj => obj.id === `${taskId}`)
    const getChild = global_comments.filter(obj => obj.parent_id === getParent.id)
    comment_parent_id = getParent.id
    document.getElementById('child_comments').innerHTML = getChild.map(obj => `
        <div style=" display: flex; gap: 10px;  margin-top: 15px; padding: 0px 15px;">
          <div style="height: 28px; width: 28px; background-color: #7F7979; border-radius: 100%;">
            <img style="height: 28px; width: 28px;  border-radius: 100%;"
              src=${extractDefaultAvatar(obj.user.img_url)} alt="">
          </div>
          <div>
            <div style="display: flex; align-items: center; gap: 5px;">
              <p style="font-weight: 500;">${obj.user.handle}</p>
              <span style="color: #BEBEBE;">${dayjs(obj.createdOn).format('YYYY-MM-DD h:mm A')}</span>
            </div>
            <p style="margin:8px 0px; color: #7F7979;">${obj.message}</p>
            <!-- <p style="color: #7F7979;">Last comment: 2 mins ago</p> -->
          </div>
        </div>
    `).join('')
    document.getElementById('comment_no').innerHTML = `Comments (${getChild.length})`
    document.getElementById('t_comment').innerHTML = `${getChild.length} Comments`
  }


  function addComment() {
    let comment = document.getElementById('add_comment').value
    parent.postMessage({ pluginMessage: { type: 'add_comment', data: { comment: comment, commss: comment_parent_id, fileId } } }, "*")
    // getTaskComment(selectedTask.figma_id)
    comment = ''
  }

  function selectTask(taskId) {
    document.getElementById("show_tag_btn").classList.remove('tags')
    document.getElementById('show_tags').classList.add('tags')
    selectedTask = ongoing_tasks.find(obj => obj.figma_id === `${taskId}`)
    document.getElementById('task_page').innerHTML = selectedTask.board_name
    document.getElementById('task_img').src = extractDefaultAvatar(selectedTask.creator_img)
    document.getElementById('task_created').innerHTML = dayjs(selectedTask.createdOn).format('YYYY-MM-DD h:mm A')
    document.getElementById('task_creator').innerHTML = selectedTask.creator_name
    document.getElementById('comment').innerHTML = selectedTask.comment

    if (selectedTask.due_date !== null) {
      document.getElementById('due_date').innerHTML = dayjs(selectedTask.due_date).format('YYYY-MM-DD')
      document.getElementById('dateInput').classList.add('page')
    }
    if (selectedTask.tags.length > 0) {
      showTags(selectedTask.tags)
    }
    fetchTasksTodo()
    getTaskComment(taskId)
  }

  // add due date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateInput').setAttribute('min', today);

  async function addDueDate(input) {
    // e.preventDefault()
    const res = await fetch(`${backend_url}/add-duedate`, {
      headers: {
        "Content-Type": "application/json",
      },
      method: "POST",
      body: JSON.stringify({

        task_id: selectedTask.id,
        date: input.value
      }),
    })
    await fetchTasksTodo()
    selectedTask(selectTask.figma_id)
  }


  window.onmessage = (event) => {
    if (event.data.pluginMessage?.type === 'idd') {
      const fileId = event.data.pluginMessage.data;
    }

    if (event.data.pluginMessage.type === "get-comment") {
      global_comments = event.data.pluginMessage.data.comments;
      getTaskComment(selectedTask.figma_id)
    }

    if (event.data.pluginMessage.type === "comment-added") {
      global_comments = event.data.pluginMessage.data;
      getTaskComment(selectedTask.figma_id)
    }

    if (event.data.pluginMessage.type === "get-user") {
      userInfo = event.data.pluginMessage.data;
      async function createUser() {
        const res = await fetch(`${backend_url}/create-user`, {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
          body: JSON.stringify({
            figma_id: userInfo.id,
            figma_email: userInfo.email,
            figma_handle: userInfo.handle,
            figma_image: userInfo.img_url
          }),
        })
      }
      createUser()
      showNextPage('page2')

    }

    if (event.data.pluginMessage.type === "get-files") {
      // console.log(event.data.pluginMessage.data.document.children[0].children)
      global_files = event.data.pluginMessage.data.data.document.children[0].children
      fileId = event.data.pluginMessage.data.fileId
      comments_withfile = global_comments.map(item1 => {
        const match = global_files.find(item2 => item2.id === item1.client_meta?.node_id);
        return { ...item1, board_name: match ? match.name : null };
      });
      async function createFile() {
        const res = await fetch(`${backend_url}/create-file`, {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
          body: JSON.stringify({
            figma_file_id: fileId,
            figma_file_key: fileId,
            figma_name: event.data.pluginMessage.data.data.name,
            user_email: userInfo.email
          }),
        })
      }
      createFile()
      getOngoingTasks(userInfo.id, fileId)
      showNextPage('page3')
      //fetchFileTodo()
    }
  };

  // helper functions 
  function formatNumber(num) {
    return num % 1 === 0 ? num.toFixed(0) : num.toFixed(2);
  }

  function extractDefaultAvatar(url) {
    const match = url.match(/default=([^&]+)/);
    return match ? decodeURIComponent(match[1]) : url;
  }

  function getFigmaFileKey(url) {
    const match = url.match(/design\/([a-zA-Z0-9]+)\//);
    return match ? match[1] : null;
  }
</script>

</html>